---
title: "GGPlot Project"
author: "Olivia  & Yulia"
date: '2022-11-22'
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}

#Open libraries

knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(tidyverse)
library(kableExtra)
library(ggthemes)
library(sjmisc)
library(raster)
library(stringr)
library(flexdashboard)
library(paletteer)
library(mgcv)


# Read in Happiness Report data
 
report2019 <- read.csv("HappinessReport/2019.csv", header = TRUE, sep = ",")
report2018 <- read.csv("HappinessReport/2018.csv", header = TRUE, sep = ",")
report2017 <- read.csv("HappinessReport/2017.csv", header = TRUE, sep = ",")
report2016 <- read.csv("HappinessReport/2016.csv", header = TRUE, sep = ",")
report2015 <- read.csv("HappinessReport/2015.csv", header = TRUE, sep = ",")
# Add a year column to each data set
report2019$Year <- 2019
report2018$Year <- 2018
report2017$Year <- 2017
report2016$Year <- 2016
report2015$Year <- 2015


selectColumns <- c("Happiness.Rank", "Country",'Happiness.Score', 'Economy..GDP.per.Capita.', 'Family', 'Health..Life.Expectancy.', 'Freedom', 'Generosity', 'Trust..Government.Corruption.', 'Year')

columns <- c('Overall.rank', 'Country.or.region','Score','GDP.per.capita','Social.support','Healthy.life.expectancy','Freedom.to.make.life.choices','Generosity','Perceptions.of.corruption', 'Year')


# Standardize all column names and categories
report2015 <- report2015[,selectColumns]
report2016 <- report2016[,selectColumns]
report2017 <- report2017[,selectColumns]
colnames(report2015) <- columns
colnames(report2016) <- columns
colnames(report2017) <- columns

# Create one data frame with all years combined
reportTotal <- rbind(report2016, report2015, report2017, report2018, report2019)

# Add continent column for later analysis 
reportTotal <- merge(x=reportTotal,y=ccodes()[,c('NAME','UNREGION1','continent')], 
      by.x=c("Country.or.region"), 
      by.y=c("NAME"),
      all.x=TRUE)



# Update Country Names only for the map graph - reference with report2019a
report2019a <- report2019

report2019a[report2019a$Country.or.region=="United States", "Country.or.region"] <- "USA"
report2019a[report2019a$Country.or.region=="United Kingdom", "Country.or.region"] <- "UK"
report2019a[report2019a$Country.or.region=="Congo (Brazzaville)", "Country.or.region"] <- "Democratic Republic of the Congo"
report2019[report2019a$Country.or.region=="Congo (Kinshasa)", "Country.or.region"] <- "Democratic Republic of the Congo"
report2019a


```

# World Happiness Report {.tabset .tabset-fade}
<br>
In 2012 the United Nations published the first results of the World Happiness Report, a first of its kind initiative to track the state of different countries around the world. Data is obtained from the Gallup World Poll. The report includes over 150 countries and measures different variables relating to well-being. Some of these variables include GDP, perceptions of corruption, generosity, social support, and more. 


The data set used to create the graphs below was obtained from [Kaggle](https://www.kaggle.com/datasets/unsdsn/world-happiness?resource=download) and includes the years from 2015 to 2019. 

<br>

## Overview

<h2>Index of Happiness in 2019</h2>

The map below represents the happiness index (answers to the Cantril
ladder question) of each country, based on the data collected in 2019.
The most happy countries are shown by the lighter color while the least
happy countries have a darker shade of blue.

**Happiness Index Map, 2019**

```{r map, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12}

world_map = map_data("world") %>% 
  filter(! long > 180)

report2019a %>% 
  ggplot(aes(fill = Score, map_id = Country.or.region)) +
  geom_map(map = world_map) +
  expand_limits(x = world_map$long, y = world_map$lat) +
  coord_map("moll") +
  theme_map()

```

By using the map, we can compare the situation between different regions
and have a glance at the countries' indexes. For example, North America
seems to be a happier region than Africa and Ukraine is slightly behind
most other European countries.

<h2>Recognized leaders</h2>

It would be nice to know how to improve the situation into your own
country. Let's look at the examples to follow by determining the leaders
in each category.

```{=html}
<style>

.header{
  text-align: center;
}

</style>
```

<h3 class="header">
Top 3 happiest countries
</h3>

```{r leaders, fig.align='center', echo=FALSE, fig.height=2, warning=FALSE}

#Bring together leaders from each category into one table

score_top3 <- report2019a %>% arrange(desc(Score))
score_top3 <- score_top3 %>% dplyr::select("Country.or.region","Score")
score_top3 <- score_top3[1:3,]


# Function that formats the top three countries of selected categories
createValueBoxes <- function(df, h = 4, w = 6, padding=0.5, rows = 1){
  
  boxes = nrow(df) # number of items passed
  
# calculate the grid
  cols = 3
    
  df <- data.frame(
      x = rep(seq(0, (w+padding)*cols-1, w+padding), times=rows),
      y = rep(seq(0, (h)*rows-4)),
      h = rep(h, boxes),
      w = rep(w, boxes),
      value = df[[2]],
      info = df[[1]],
      color = factor(1:3)
  )
  
  ggplot(df, aes(x, y, height = h, width = w, label = info)) +
  ## Create the tiles using the `color` column
      geom_tile(aes(fill = color)) +
  ## Add the numeric values as text in `value` column
      geom_text(color = "white", fontface = "bold", size = 10,
                aes(label = value, x = x - 2.9, y = y + 1), hjust = 0) +
  ## Add the labels for each box stored in the `info` column
      geom_text(color = "white", fontface = "bold",
                aes(label = info, x = x - 2.9, y = y - 1), hjust = 0) +
      coord_fixed() +
      scale_fill_brewer(type = "qual",palette = "Dark2") +
  ## Erase the legend
      theme_void() +
      guides(fill = FALSE)
}
createValueBoxes(score_top3)

```

<h3 class="header">

I. GDP per capita

</h3>

```{r gdp, fig.align='center', echo=FALSE, fig.height=2, warning=FALSE}

gdp_top3 <- report2019a %>% arrange(desc(GDP.per.capita))
gdp_top3 <- gdp_top3 %>% dplyr::select("Country.or.region","GDP.per.capita")
gdp_top3 <- gdp_top3[1:3,]

createValueBoxes(gdp_top3)

```

<h3 class="header">

II.Social support

</h3>

```{r social_sup, fig.align='center', echo=FALSE, fig.height=2, warning=FALSE}

socsup_top3 <- report2019a %>% arrange(desc(Social.support))
socsup_top3 <- socsup_top3 %>% dplyr::select("Country.or.region","Social.support")
socsup_top3 <- socsup_top3[1:3,]

createValueBoxes(socsup_top3)

```

<h3 class="header">

III.Healthy life expectancy

</h3>

```{r health, fig.align='center', echo=FALSE, fig.height=2, warning=FALSE}

health_top3 <- report2019a %>% arrange(desc(Healthy.life.expectancy))
health_top3 <- health_top3 %>% dplyr::select("Country.or.region","Healthy.life.expectancy")
health_top3 <- health_top3[1:3,]

createValueBoxes(health_top3)

```

<h3 class="header">

IV.Freedom of choice

</h3>

```{r freedom, fig.align='center', echo=FALSE, fig.height=2, warning=FALSE}

freedom_top3 <- report2019a %>% arrange(desc(Freedom.to.make.life.choices))
freedom_top3 <- freedom_top3 %>% dplyr::select("Country.or.region","Freedom.to.make.life.choices")
freedom_top3 <- freedom_top3[1:3,]

createValueBoxes(freedom_top3)

```

<h3 class="header">

V.Generosity

</h3>

```{r generosity, fig.align='center', echo=FALSE, fig.height=2, warning=FALSE}

generosity_top3 <- report2019a %>% arrange(desc(Generosity))
generosity_top3 <- generosity_top3 %>% dplyr::select("Country.or.region","Generosity")
generosity_top3 <- generosity_top3[1:3,]

createValueBoxes(generosity_top3)

```

<h3 class="header">

VI.Perception of corruption

</h3>

```{r corruption, fig.align='center', echo=FALSE, fig.height=2, warning=FALSE}

corruption_top3 <- report2019a %>% arrange(desc(Perceptions.of.corruption))
corruption_top3 <- corruption_top3 %>% dplyr::select("Country.or.region","Perceptions.of.corruption")
corruption_top3 <- corruption_top3[1:3,]

createValueBoxes(corruption_top3)

```

We can see that the leaders change from category to category. In the
next section the difference between the overall countries' rankings and
their scores in each categories will be even more present. As for now,
we can tell that the happiest country would be probably the with GDP per
capita of Qatar, social support of Iceland, perception of corruption and
health level of Singapore, freedom of choice of Uzbekistan\*, and
generosity of Myanmar. We can also see that the leaders in social
support lead in the overall happiness index as well (even though Denmark
is not at the top-3, it is the fourth).

*\* - As a person from the nearby country I highly question the score of
Uzbekistan in this category. Therefore,I would advise not to use this
list as 100% correct example.*

## Top/bottom analysis

<h2>Comparison between the most happy and the least happy countries</h2>

Do the happiest countries lead in any aspect and wise versa? To find an
answer to this question, let's look at the table below. It includes the
comparison between the top and bottom 10 countries by the Happiness
index (from Finland to Austria and from Haiti to South Sudan).

The best scores overall and for each categories are determined
separately and highlighted by the background colour, where green
represents the best scores and violet represents the worst ones.

```{r topbottom10, echo=FALSE, message=FALSE, warning=FALSE}

topbottomtable <- report2019a[c(1:10, (nrow(report2019a)-9):nrow(report2019a)),]
topbottomtable <- topbottomtable[,(2:9)]


#Create kabble

kbl(topbottomtable, booktabs = T, linesep = "", align = "c", 
    caption = "Distribution of the scores for the best and worst countries", 
    col.names = c("Country", "Happiness index", "GDP per capita", "Social support", "Healthy life expectancy", "Freedom of choice", "Generosity","Perception of corruption")) %>%
  
  kable_styling(full_width = F) %>%
  kable_styling(font_size = 12, position = "center") %>% 
  kable_styling(latex_options = "hold_position") %>% 
  column_spec(3, color = "white", background = spec_color(topbottomtable$Score, end = 0.9, option = "viridis")) %>% 
  column_spec(4, color = "white", background = spec_color(topbottomtable$GDP.per.capita, end = 0.9, option = "viridis")) %>% 
  column_spec(5, color = "white", background = spec_color(topbottomtable$Social.support, end = 0.9, option = "viridis")) %>% 
  column_spec(6, color = "white", background = spec_color(topbottomtable$Healthy.life.expectancy, end = 0.9, option = "viridis")) %>% 
  column_spec(7, color = "white", background = spec_color(topbottomtable$Freedom.to.make.life.choices, end = 0.9, option = "viridis")) %>% 
  column_spec(8, color = "white", background = spec_color(topbottomtable$Generosity, end = 0.9, option = "viridis")) %>% 
  column_spec(9, color = "white", background = spec_color(topbottomtable$Perceptions.of.corruption, end = 0.9, option = "viridis"))


```

One of the most interesting observations that we can make based on this
data is that generosity and perception of corruption are distributed
very differently from all other categories. Haiti, being one of the
worst countries by the Happiness index, is also one of the leaders by
Generosity category. On the other hand, happiest countries usually have
very high GDP, social support, health level, and freedom of choice.

<h2>The difference in happiness level</h2>

We can also take a look at how big the difference in the happiness level
between the general leaders and the outsider is. A comparison is made in
the graph below:

```{r top10, echo=FALSE, message=FALSE, warning=FALSE}

report2019[c(1:10, (nrow(report2019)-9):nrow(report2019)),]  %>% 
  ggplot(aes(x=reorder(Country.or.region,-Score,sum), y=Score, fill = Score)) +
  geom_bar(stat="summary", fun="mean") + 
  coord_flip() +
  geom_hline(yintercept = mean(report2019$Score))




```

It is totally worth noting that the happiest countries are twice as
happy in comparison to the least happy countries. The division is very
high, regardless of inequality in distribution between some categories.

## France
<br>

France is displayed here for the purposes of viewing data from an individual country in the data set. For the years 2015 to 2019, France has consistently ranked among the top 25% in the World Happiness Report, it's ranking ranging from 32 to 24 (where a low score indicates a higher ranking of happiness in relation to other countries in the survey).

<br>

<h3> France Rank 2015-2019 </h3>
```{r echo=FALSE, message=FALSE, warning=FALSE}

france <- filter(reportTotal, Country.or.region == "France")

ggplot(france, aes(x = Year, y = Overall.rank)) + 
    geom_line() +
    scale_y_reverse()

```
<br>
<h3> Change percentage by category</h3>
<br>

The following graphs represent the six different metrics used to gauge the overall Happiness Score of France. The graph represent the percentage of change in each category. 


With a brief glance at the charts, we may observe similar patterns among the categories in contrast to the overall ranking (displayed above). It appears that health & life expectancy, perception of corruption, and freedom to make life choices have similar trends in relation to the overall happiness score. On the other hand, it appears as though GDP per capita follows and opposite pattern, where the years with the highest score for gdp also represent the years with the lowest scores for overall happiness. 

<br>
```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10}

library(reshape2)
library(scales)

#Create copy to calculate percentages
francePct <- france

#For each column in all rows, calculate the percentage of the value as compared to 2015
for( i in 1:5){
  for(k in 2:9){
    francePct[i,k] <- (as.numeric(as.character(france[i,k])) - as.numeric(as.character(france[5,k])))/ as.numeric(as.character(france[5,k]))
  }
}

# Select only the columns we want
francePct <- francePct[4:10]
# "melt" data so that each row is a unique id-variable combination
francePct <- melt(francePct, id.vars = 'Year', variable.name= 'series')

#Change data type to numeric to perform calculations
francePct$value <- as.numeric(francePct$value)

# plot a line graph for each different category
ggplot(francePct, aes(Year, value)) +
  geom_line(aes(colour = series)) +
  geom_point(aes(colour = series)) +
  scale_y_continuous(labels = scales::percent) +
  facet_wrap(~series)

```



## Continent


<h3>Average happiness score by continent from 2015 - 2019</h3>
<br>
The continent with the highest average happiness score is Oceania (Australia and New Zealand). The continent with the lowest is Africa, though it does show a slight increase in it's score over the years. South America shows the greatest decrease in score. 
<br>
```{r echo=FALSE, message=FALSE, warning=FALSE }

report2019 <- merge(x=report2019,y=ccodes()[,c('NAME','UNREGION1','continent')], 
      by.x=c("Country.or.region"), 
      by.y=c("NAME"),
      all.x=TRUE)

report2019 <- na.omit(report2019)

# Get the mean of each category for each continent for each year
stats <- reportTotal %>% 
          group_by(continent, Year) %>% 
          summarize_all(mean)


ggplot(stats[1:30,], aes(Year, Score, group_by(continent))) +
  geom_line(aes(colour = continent)) +
  geom_point(aes(colour = continent))

```

<h3> Change in rank from 2015 - 2019</h3>
<br>

**Note - Countries are ranked, therefore the higher the score, the lower the level of happiness for a country**

The countries that have decreased in ranking the most are countries that are in the lower 30%.
As shown below, the 3 countries with the greatest decrease in ranking are Venezuela, Zambia, and Lesotho. The 3 countries with the greatest improvement in ranking are Benin, Honduras, and Hungary. 
<br>
```{r echo=FALSE, message=FALSE, warning=FALSE, fig.width=10, fig.height=5}

report <- merge(x = report2019, y = report2015, by = "Country.or.region", all = TRUE)

report["Change.in.Rank"] <- report[,"Overall.rank.x"] - report[,"Overall.rank.y"]

report <- report[order(report$Change.in.Rank),]
report <- na.omit(report)


ggplot(report[c(1:10, 135:145),], aes(x=reorder(Country.or.region, Change.in.Rank), y=Change.in.Rank, fill=Overall.rank.x)) + 
  geom_bar(stat='identity', width=.5)  +
  coord_flip()
  

```


# 
